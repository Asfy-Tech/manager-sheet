<!DOCTYPE html>
<html
  lang="en"
  data-layout="vertical"
  data-topbar="light"
  data-sidebar="dark"
  data-sidebar-size="lg"
  data-sidebar-image="none"
  data-preloader="disable"
>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      content="Premium Multipurpose Admin & Dashboard Template"
      name="description"
    />
    <meta content="Themesbrand" name="author" />
    <!-- App favicon -->
    <link
      rel="shortcut icon"
      href="[[ url_for('static',filename='images/favicon.ico') ]]"
    />
    <!-- Layout config Js -->
    <script src="[[ url_for('static',filename='js/layout.js') ]]"></script>
    <!-- Bootstrap Css -->
    <link
      href="[[ url_for('static',filename='css/bootstrap.min.css') ]]"
      rel="stylesheet"
      type="text/css"
    />
    <!-- Icons Css -->
    <link
      href="[[ url_for('static',filename='css/icons.min.css') ]]"
      rel="stylesheet"
      type="text/css"
    />
    <!-- App Css-->
    <link
      href="[[ url_for('static',filename='css/app.min.css') ]]"
      rel="stylesheet"
      type="text/css"
    />
    <!-- custom Css-->
    <link
      href="[[ url_for('static',filename='css/custom.min.css') ]]"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="[[ url_for('static',filename='css/select2.min.css') ]]"
      rel="stylesheet"
      type="text/css"
    />
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script> -->
    <title>{% block title %}{% endblock %}</title>
    {% block style %}{% endblock %}
    <style>
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .icon i {
        animation: spin 1s linear infinite !important;
      }
      .icon {
        animation: spin 1s linear infinite !important;
      }
    </style>
  </head>

  <body>
    <!-- Begin page -->
    <div id="layout-wrapper">
      <header id="page-topbar">
        <div class="layout-width">
          <div class="navbar-header">
            <div class="d-flex">
              <!-- LOGO -->
              <!-- <div class="navbar-brand-box horizontal-logo">
                <a href="index.html" class="logo logo-dark">
                  <span class="logo-sm">
                    <img
                      src="[[ url_for('static',filename='images/logo-sm.png') ]]"
                      alt=""
                      height="22"
                    />
                  </span>
                  <span class="logo-lg">
                    <img
                      src="[[ url_for('static',filename='images/logo-dark.png') ]]"
                      alt=""
                      height="17"
                    />
                  </span>
                </a>

                <a href="index.html" class="logo logo-light">
                  <span class="logo-sm">
                    <img
                      src="[[ url_for('static',filename='images/logo-sm.png') ]]"
                      alt=""
                      height="22"
                    />
                  </span>
                  <span class="logo-lg">
                    <img
                      src="[[ url_for('static',filename='images/logo-light.png') ]]"
                      alt=""
                      height="17"
                    />
                  </span>
                </a>
              </div> -->

              <button
                type="button"
                class="btn btn-sm px-3 fs-16 header-item vertical-menu-btn topnav-hamburger"
                id="topnav-hamburger-icon"
              >
                <span class="hamburger-icon">
                  <span></span>
                  <span></span>
                  <span></span>
                </span>
              </button>
            </div>

            <div id="appnotifi" class="d-flex align-items-center">
              <div
                class="dropdown topbar-head-dropdown ms-1 header-item"
                id="notificationDropdown"
              >
                <button
                  type="button"
                  class="btn btn-icon btn-topbar btn-ghost-secondary rounded-circle"
                  id="page-header-notifications-dropdown"
                  data-bs-toggle="dropdown"
                  data-bs-auto-close="outside"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <i class="bx bx-bell fs-22"></i>
                  <span class="position-absolute topbar-badge fs-10 translate-middle badge rounded-pill bg-danger" v-text="unreadCount">
                  </span>
                </button>
                <div
                  class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0"
                  aria-labelledby="page-header-notifications-dropdown"
                >
                  <div class="dropdown-head bg-primary bg-pattern rounded-top">
                    <div class="p-3">
                      <div class="row align-items-center">
                        <div class="col">
                          <h6 class="m-0 fs-16 fw-semibold text-white">
                            Thông báo
                          </h6>
                        </div>
                        <div class="col-auto dropdown-tabs">
                          <button :disabled="isLoadingRemove" @click="handleRemoveNoti" class="btn bg-light-subtle text-body fs-13">Dọn dẹp</button>
                        </div>
                      </div>
                    </div>

                    <div class="px-2 pt-2">
                      <ul
                        class="nav nav-tabs dropdown-tabs nav-tabs-custom"
                        data-dropdown-tabs="true"
                        id="notificationItemsTab"
                        role="tablist"
                      >
                        <li class="nav-item waves-effect waves-light">
                          <a
                            class="nav-link active"
                            data-bs-toggle="tab"
                            href="#all-noti-tab"
                            role="tab"
                            aria-selected="true"
                          >
                            All ({{unreadCount}})
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>

                  <div
                    class="tab-content position-relative"
                    id="notificationItemsTabContent"
                  >
                    <div
                      class="tab-pane fade show active py-2 ps-2"
                      id="all-noti-tab"
                      role="tabpanel"
                    >
                      <div
                        data-simplebar
                        style="max-height: 300px"
                        class="pe-2"
                      >
                        <div
                          class="text-reset notification-item d-block dropdown-item position-relative"
                          v-for="item in notifications"
                          :key="item.id"
                        >
                          <div class="d-flex align-items-center">
                            <div class="avatar-xs me-3 flex-shrink-0">
                              <span
                                class="avatar-title bg-info-subtle text-info rounded-circle fs-16"
                              >
                                <i class="bx bx-badge-check"></i>
                              </span>
                            </div>
                            <div class="flex-grow-1">
                              <a href="#!" class="stretched-link">
                                <h6 class="mt-0 mb-0 lh-base">
                                  <b
                                    ><span class="text-secondary"
                                      >{{ item.title }}</span
                                    ></b
                                  >
                                  <p class="p-0 m-0">{{ item.content }}</p>
                                </h6>
                              </a>
                              <p
                                class="mb-0 fs-11 fw-medium text-uppercase text-muted"
                              >
                                <span
                                  ><i class="mdi mdi-clock-outline"></i> {{
                                  formatTime(item.created_at) }}</span
                                >
                              </p>
                            </div>
                          </div>
                        </div>

                        <!-- <div class="my-3 text-center view-all">
                          <button
                            type="button"
                            class="btn btn-soft-success waves-effect waves-light"
                          >
                            Xem tất cả
                            <i class="ri-arrow-right-line align-middle"></i>
                          </button>
                        </div> -->
                      </div>
                    </div>
                    <!-- <div class="tab-pane fade show active p-4" id="alerts-tab" role="tabpanel" aria-labelledby="alerts-tab"></div> -->
                  </div>
                </div>
              </div>

              <div class="dropdown ms-sm-3 header-item topbar-user">
                <button
                  type="button"
                  class="btn"
                  id="page-header-user-dropdown"
                  data-bs-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <span class="d-flex align-items-center">
                    <img
                      class="rounded-circle header-profile-user"
                      :src="user.avatar"
                      :alt="user.name"
                    />
                    <span class="text-start ms-xl-2">
                      <span
                        class="d-none d-xl-inline-block ms-1 fw-medium user-name-text"
                        >{{ user.name }}</span
                      >
                      <span
                        class="d-none d-xl-block ms-1 fs-12 user-name-sub-text"
                        >Marketing</span
                      >
                    </span>
                  </span>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                  <!-- item-->
                  <h6 class="dropdown-header">Welcome to Site!</h6>
                  <a class="dropdown-item" href="/settings"
                    ><i
                      class="mdi mdi-cog-outline text-muted fs-16 align-middle me-1"
                    ></i>
                    <span class="align-middle">Settings</span></a
                  >
                  <button type="button" class="dropdown-item" @click="logout">
                    <i
                      class="mdi mdi-logout text-muted fs-16 align-middle me-1"
                    ></i>
                    <span class="align-middle">Logout</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- removeNotificationModal -->
      <div
        id="removeNotificationModal"
        class="modal fade zoomIn"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
                id="NotificationModalbtn-close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mt-2 text-center">
                <lord-icon
                  src="https://cdn.lordicon.com/gsqxdxog.json"
                  trigger="loop"
                  colors="primary:#f7b84b,secondary:#f06548"
                  style="width: 100px; height: 100px"
                ></lord-icon>
                <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                  <h4>Are you sure ?</h4>
                  <p class="text-muted mx-4 mb-0">
                    Are you sure you want to remove this Notification ?
                  </p>
                </div>
              </div>
              <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                <button
                  type="button"
                  class="btn w-sm btn-light"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button
                  type="button"
                  class="btn w-sm btn-danger"
                  id="delete-notification"
                >
                  Yes, Delete It!
                </button>
              </div>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
      <!-- ========== App Menu ========== -->
      <div class="app-menu navbar-menu">
        <!-- LOGO -->
        <div class="navbar-brand-box">
          <!-- Dark Logo-->
          <a href="/" class="logo logo-dark">
            <span class="logo-sm">
              <img
                src="[[ url_for('static',filename='images/logo-sm.png') ]]"
                alt=""
                height="22"
              />
            </span>
            <span class="logo-lg">
              <img
                src="[[ url_for('static',filename='images/logo-dark.png') ]]"
                alt=""
                height="17"
              />
            </span>
          </a>
          <!-- Light Logo-->
          <!-- <a href="/" class="logo logo-light">
            <span class="logo-sm">
              <img
                src="[[ url_for('static',filename='images/logo-sm.png') ]]"
                alt=""
                height="22"
              />
            </span>
            <span class="logo-lg">
              <img
                src="[[ url_for('static',filename='images/logo-light.png') ]]"
                alt=""
                height="17"
              />
            </span>
          </a> -->
          <button
            type="button"
            class="btn btn-sm p-0 fs-20 header-item float-end btn-vertical-sm-hover"
            id="vertical-hover"
          >
            <i class="ri-record-circle-line"></i>
          </button>
        </div>

        <div id="scrollbar">
          <div class="container-fluid">
            <div id="two-column-menu"></div>
            <ul class="navbar-nav" id="navbar-nav">
              <li class="menu-title"><span data-key="t-menu">Menu</span></li>
              <li class="nav-item">
                <a class="nav-link menu-link" href="/">
                  <i class="ri-dashboard-2-line"></i>
                  <span data-key="t-dashboards">Dashboards</span>
                </a>
              </li>
              <li class="menu-title">
                <i class="ri-more-fill"></i>
                <span data-key="t-pages">App</span>
              </li>
              <li class="nav-item">
                <a class="nav-link menu-link" href="/tasks">
                  <i class="ri-file-copy-line"></i>
                  <!-- Thay icon tài liệu tổng hợp -->
                  <span data-key="t-authentication">File tổng hợp</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link menu-link" href="/watch-sheets">
                  <i class="ri-building-line"></i>
                  <!-- Thay icon danh sách công ty -->
                  <span data-key="t-authentication">Danh sách công ty</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link menu-link" href="/telegrams/users">
                  <i class="ri-user-3-line"></i>
                  <!-- Thay icon danh sách nhân sự -->
                  <span data-key="t-authentication">Danh sách nhân sự</span>
                </a>
              </li>
            </ul>
          </div>
          <!-- Sidebar -->
        </div>

        <div class="sidebar-background"></div>
      </div>
      <!-- Left Sidebar End -->
      <!-- Vertical Overlay-->
      <div class="vertical-overlay"></div>

      <!-- ============================================================== -->
      <!-- Start right Content here -->
      <!-- ============================================================== -->
      <div class="main-content">
        {% block content %}{% endblock %}
        <footer class="footer">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-6">
                <script>
                  document.write(new Date().getFullYear());
                </script>
                © Velzon.
              </div>
              <div class="col-sm-6">
                <div class="text-sm-end d-none d-sm-block">
                  Design & Develop by Themesbrand
                </div>
              </div>
            </div>
          </div>
        </footer>
      </div>
      <!-- end main content-->
    </div>
    <!-- END layout-wrapper -->

    <!--start back-to-top-->
    <button
      onclick="topFunction()"
      class="btn btn-danger btn-icon"
      id="back-to-top"
    >
      <i class="ri-arrow-up-line"></i>
    </button>
    <!--end back-to-top-->

    <!--preloader-->
    <div id="preloader">
      <div id="status">
        <div class="spinner-border text-primary avatar-sm" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>

    <!-- JAVASCRIPT -->
    <script src="[[ url_for('static',filename='libs/bootstrap/js/bootstrap.bundle.min.js') ]]"></script>
    <script src="[[ url_for('static',filename='libs/simplebar/simplebar.min.js') ]]"></script>
    <script src="[[ url_for('static',filename='libs/node-waves/waves.min.js') ]]"></script>
    <script src="[[ url_for('static',filename='libs/feather-icons/feather.min.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/pages/plugins/lord-icon-2.1.0.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/plugins.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/axios.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/jquery.min.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/moment.min.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/moment.local.js') ]]"></script>
    <script src="[[url_for('static',filename='js/pages/select2.min.js')]]"></script>
    <script src="[[url_for('static',filename='js/pages/select2.init.js')]]"></script>
    <script src="[[ url_for('static',filename='libs/apexcharts/apexcharts.min.js') ]]"></script>
    <!-- <script src="[[ url_for('static',filename='js/pages/dashboard-projects.init.js') ]]"></script> -->
    <script src="[[ url_for('static',filename='js/app.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/custom.js') ]]"></script>
    <script src="[[ url_for('static',filename='js/vue3.js') ]]"></script>
    <script>
      const appnotifi = Vue.createApp({
        setup() {
          const user = Vue.ref({});
          const isLoadingRemove = Vue.ref(false);
          const notifications = Vue.ref([]);
          const unreadCount = Vue.ref(0);

          const fetchNotifications = async () => {
            try {
              const response = await axios.get("/api/notifications");
              if (response.data.success) {
                notifications.value = response.data.data;
                unreadCount.value = response.data.unread_count;
              } else {
                console.error("Lỗi API:", response.data.error);
              }
            } catch (error) {
              console.error("Lỗi khi gọi API:", error);
            }
          };

          function formatTime(time) {
            return moment(time).fromNow();
          }

          Vue.onMounted(() => {
            fetchNotifications();
            user.value = JSON.parse(localStorage.getItem('user'))
          });

          const handleRemoveNoti = async () => {
            isLoadingRemove.value = true
            try {
              const response = await axios.delete("/api/notifications");
              await fetchNotifications()
            } catch (error) {
              console.error("Lỗi khi logout:", error);
            }finally{
              isLoadingRemove.value = false
            }
          };

          const logout = async () => {
            try {
              await axios.post(
                "/api/logout",
                {},
                {
                  headers: {
                    Authorization: `Bearer ${localStorage.getItem("authToken")}`,
                  },
                }
              );
            } catch (error) {
              console.error("Lỗi khi logout:", error);
            }
            localStorage.removeItem("authToken");
            localStorage.removeItem("user");
            window.location.href = "/login";
          };

          return { notifications, isLoadingRemove, handleRemoveNoti, user, unreadCount, formatTime, logout };
        },
      });

      appnotifi.mount("#appnotifi");
    </script>
    {% block script %}{% endblock %}
  </body>
</html>
