{% extends "layouts/app.html" %} {% block title %}Settings{% endblock %} {%
block style %} {% endblock %} {% block content %}
<div class="page-content" id="app">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div
          class="page-title-box d-sm-flex align-items-center justify-content-between"
        >
          <h4 class="mb-sm-0">Cài đặt</h4>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xxl-12">
        <div class="card">
          <div class="card-header">
            <ul
              class="nav nav-tabs-custom rounded card-header-tabs border-bottom-0"
              role="tablist"
            >
              <li class="nav-item">
                <a
                  class="nav-link active"
                  data-bs-toggle="tab"
                  href="#configUpload"
                  role="tab"
                >
                  <i class="fas fa-cog"></i> Cấu hình
                </a>
              </li>
            </ul>
          </div>
          <div class="card-body p-4">
            <div class="tab-content">
              <div class="tab-pane active" id="configUpload" role="tabpanel">
                <!-- Upload Form -->
                <form @submit.prevent="uploadConfig" class="mb-4">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="mb-3">
                        <label for="configFile" class="form-label"
                          >Tải lên cấu hình google api</label
                        >
                        <input
                          type="file"
                          class="form-control"
                          id="configFile"
                          @change="handleFileUpload"
                          accept=".json"
                        />
                      </div>
                    </div>
                    <div class="col-lg-12">
                      <div class="hstack gap-2 justify-content-end">
                        <button type="submit" class="btn btn-primary">
                          Đẩy lên cấu hình
                        </button>
                      </div>
                    </div>
                  </div>
                </form>

                <!-- Configuration Display -->
                <div
                  class="row mt-4"
                  v-if="Object.keys(credentials).length > 0"
                >
                  <div class="col-lg-12">
                    <h5 class="mb-3">Current Configuration</h5>
                    <div class="table-responsive">
                      <table class="table table-bordered">
                        <tbody>
                          <tr v-for="(value, key) in credentials" :key="key">
                            <th width="250">{{ formatLabel(key) }}</th>
                            <td>{{ formatValue(key, value) }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  const app = Vue.createApp({
    setup() {
      const credentials = Vue.ref({});

      Vue.onMounted(async () => {
        await loadConfig();
      });

      const loadConfig = async () => {
        try {
          let res = await axios.get("/api/settings/");
          if (res.status == 200) {
            const data = res.data;
            credentials.value = data;
          }
        } catch (e) {
          console.error(e);
          showToast(e?.response?.data?.message || "Error loading configuration", "error");
        }
      };

      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (file && !file.type.includes("json")) {
          showToast("Vui lòng upload file .json", "error");
          event.target.value = "";
        }
      };

      const uploadConfig = async (event) => {
        const fileInput = document.getElementById("configFile");
        const file = fileInput.files[0];

        if (!file) {
          showToast("Vui lòng chọn file", "error");
          return;
        }

        const formData = new FormData();
        formData.append("config", file);

        try {
          const res = await axios.post("/api/settings/upload", formData, {
            headers: {
              "Content-Type": "multipart/form-data",
            },
          });

          if (res.status == 200) {
            showToast("Cập nhật file cấu hình thành công", "success");
            await loadConfig();
            fileInput.value = "";
          }
        } catch (e) {
          console.error(e);
          showToast("Error uploading configuration", "error");
        }
      };

      const showToast = (message, type = "success") => {
        Toastify({
          text: message,
          duration: 3000,
          gravity: "top",
          position: "right",
          backgroundColor: type === "success" ? "#4caf50" : "#f44336",
          close: true,
          stopOnFocus: true,
        }).showToast();
      };

      const formatLabel = (key) => {
        return key.replace(/_/g, " ").toUpperCase();
      };

      const formatValue = (key, value) => {
        if (key === "private_key") {
          return "****" + value.slice(-4);
        }
        return value;
      };

      return {
        handleFileUpload,
        uploadConfig,
        credentials,
        formatLabel,
        formatValue,
      };
    },
  });

  app.mount("#app");
</script>
{% endblock %}
